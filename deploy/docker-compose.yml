version: '3.8'

services:
  app:
    image: ghcr.io/melonseo/trendstream:latest
    container_name: trendstream-app
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_PASSWORD: ${DB_PASSWORD}
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET}
      NAVER_KEYWORDS: ${NAVER_KEYWORDS:-백엔드,AI,클라우드}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      AI_PROVIDER: ${AI_PROVIDER:-groq}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - trendstream-network
    restart: always

  db:
    image: mysql:8.0
    container_name: trendstream-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: trend_stream
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - trendstream-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always

  redis:
    image: redis:7-alpine
    container_name: trendstream-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - trendstream-network
    restart: always

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: trendstream-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-log:/var/lib/zookeeper/log
    networks:
      - trendstream-network
    restart: always

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: trendstream-kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data
    depends_on:
      - zookeeper
    networks:
      - trendstream-network
    restart: always

  caddy:
    image: caddy:2-alpine
    container_name: trendstream-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - app
    networks:
      - trendstream-network
    restart: always

networks:
  trendstream-network:
    driver: bridge

volumes:
  db-data:
  redis-data:
  zookeeper-data:
  zookeeper-log:
  kafka-data:
  caddy-data:
  caddy-config:
