version: '3.8'

services:
  # Spring Boot 애플리케이션
  app:
    image: ghcr.io/melonseo/trendstream:latest
    container_name: trendstream-app
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_PASSWORD: ${DB_PASSWORD}
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      AI_PROVIDER: ${AI_PROVIDER:-groq}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - trendstream-network
    restart: always

  # MySQL 데이터베이스
  db:
    image: mysql:8.0
    container_name: trendstream-db
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: trend_stream
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - trendstream-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always

  # Redis
  redis:
    image: redis:7-alpine
    container_name: trendstream-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - trendstream-network
    restart: always

  # Zookeeper
  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: trendstream-zookeeper
    environment:
      ALLOW_ANONYMOUS_LOGIN: "yes"
    volumes:
      - zookeeper-data:/bitnami/zookeeper
    networks:
      - trendstream-network
    restart: always

  # Kafka
  kafka:
    image: bitnami/kafka:3.7
    container_name: trendstream-kafka
    environment:
      KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/bitnami/kafka
    depends_on:
      - zookeeper
    networks:
      - trendstream-network
    restart: always

  # Caddy (리버스 프록시)
  caddy:
    image: caddy:2-alpine
    container_name: trendstream-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - app
    networks:
      - trendstream-network
    restart: always

networks:
  trendstream-network:
    driver: bridge

volumes:
  db-data:
  redis-data:
  zookeeper-data:
  kafka-data:
  caddy-data:
  caddy-config:
